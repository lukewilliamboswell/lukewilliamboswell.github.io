<!DOCTYPE html><html  lang="en" class="no-js"><head><meta  charset="utf-8"><title></title><meta  name="description" content=""><meta  name="viewport" content="width=device-width"><link  rel="stylesheet" href="/site.css"></head><body  id="index-page"><main><p><a href="/">Return to Home</a></p>
<h1>Building a GUI platform - Action-State using <a href="https://ziglang.org">zig</a> and <a href="https://www.raylib.com">raylib</a></h1>
<p><time class="post-date" datetime="2024-01-25">25 Jan 2024</time> <em>~15 mins reading time</em></p>
<p>This is my experience about what I have learnt from developing a GUI platform using zig and raylib. I hope you find it useful, and I encourage you to build a platform as it is a great a way to learn more about <a href="https://roc-lang.org">roc</a>.</p>
<p>Richard Feldman has a draft <a href="https://docs.google.com/document/d/16qY4NGVOHu8mvInVD-ddTajZYSsFvFBvQON_hmyHGfo/edit?usp=sharing">Design Idea: Action-State</a> which outlines an idea for User-Interfaces (UI). His idea is similar to, but different from how UI are built in Elm with <a href="https://guide.elm-lang.org/architecture/">The Elm Architecture (TEA)</a>. It is tailored for plugins with an <code>Init</code> and <code>Render</code> function, instead of the <code>Model</code>, <code>View</code>, <code>Update</code> found in TEA.</p>
<p>After working on the <a href="https://github.com/lukewilliamboswell/roc-wasm4">roc-wasm4</a> zig platform with Brendan Hansknecht, I wanted to explore Action-State and am pleased to have something minimal working.</p>
<p>The code here isn't polished, I've been iterating on API ideas and generally exploring new things. There is a lot more for me to learn about roc, zig, and platform development. However, I want to share what I have, flaws and all, for the benefit of others.</p>
<p>This platform could become useful for building cross-platform GUIs with roc someday, however there is still a lot of work to do. I don't see any major blocking issues, and look forward to working on this further.</p>
<p>In this article I discuss various topics relating to platforms and applications. If you would like to learn more about these then check out <a href="https://roc-lang.org/platforms">the offical guide</a>. I have gained most of my knowledge through experiments and assistance from the community, and I highly recommend reaching out on <a href="https://roc.zulipchat.com">roc zulip</a> if you have any questions.</p>
<p>P.S. If you're reading this and have any interest in writing a layout algorithm for GUI's in pure roc, then please let me know. This would help make this even more awesome!</p>
<p>These are the steps I cover in this article. </p>
<ul>
<li><a href="#goals">Goals</a></li>
<li><a href="#demo">Demo</a></li>
<li><a href="#step1">Step 1 minimal platform</a></li>
<li><a href="#step2">Step 2 raylib library</a></li>
<li><a href="#step3">Step 3 roc &lt;-&gt; host interface</a></li>
<li><a href="#glue-llvm">Glue &amp; LLVM IR</a></li>
<li><a href="#step4">Step 4 calling roc</a></li>
<li><a href="#step5">Step 5 adding an effect</a></li>
<li><a href="#step6">Step 6 roc &lt;-&gt; roc interface</a></li>
<li><a href="#reflection">Reflection</a></li>
<li><a href="#source">Source code</a></li>
</ul>
<h2 id="goals"><a href="#goals">My Goals</a></h2>
<ol>
<li>Learn more about Roc, platform dev, and have fun</li>
<li>Implement a <a href="https://ziglang.org">zig</a> platform that uses <a href="https://www.raylib.com">raylib</a> for graphics</li>
<li>Implement the Action-State design idea</li>
</ol>
<h2 id="demo"><a href="#demo">Demo</a></h2>
<p>The code for this demo is located at <a href="https://github.com/lukewilliamboswell/roc-ray/blob/main/examples/gui-counter.roc">github.com/lukewilliamboswell/roc-ray</a>. It includes a working implementation for the Counter example used in the Action-State design idea. The demo shows three counters in a window that can be independently modified and retain their own state in the <code>Model</code>. User actions from clicking the buttons update the state of the <code>Model</code> using an <code>Action</code>.</p>
<p>To run this locally I used <a href="https://www.roc-lang.org">roc</a>, <a href="https://ziglang.org">zig</a> version 0.11.0, and <a href="https://www.raylib.com">raylib</a>.</p>
<img class="demo-img" src="/roc-ray-experiment/demo.gif" alt="screen capture of the counter demo application being used"/>
<h2 id="step1"><a href="#step1">Step 1 minimal platform</a></h2>
<p>To get started, I copied and modified another platform to suit raylib. I combined different parts from <a href="https://github.com/lukewilliamboswell/roc-wasm4">roc-wasm4</a>, <a href="https://github.com/lukewilliamboswell/roc-zig-package-experiment">roc-zig-package-experiment</a>, and <a href="https://github.com/roc-lang/roc/tree/main/examples/platform-switching">roc-lang/platform-switching</a>. I wanted the API from roc-wasm and the implementation for the low-level parts from the platform-switching example.</p>
<p>I want application authors to use just <code>roc run</code> and have a working application. If I can avoid complicated build dependencies or setup I think this would be a more friendly platform to use. </p>
<p>To do this the platform needs to generate the pre-built files e.g. <code>macos-arm64.a</code> using a <code>build.zig</code> script. These binaries can then be packaged into a <code>.tar</code> suitable for distribution using <code>roc build --bundle .tar.br platform/main.roc</code>. This package also includes the roc source code, as this is the API applications use for this platform.</p>
<p>Cross-compiling for different architectures using zig is easy, so I hope that including raylib and necessary dependencies in this platform will be easy to build static libraries for the prebuilt-binaries. When a roc application uses a platform from a URL, roc uses the prebuilt-binary. This means application authors don't need to have the zig host toolchain installed.</p>
<p>Using <code>roc dev --prebuilt-platform example.roc</code> runs the application. The roc cli finds the prebuilt-platform at a relative path e.g. <code>packages { ray: "../platform/main.roc" }</code>. The platform is built separately from the roc application. </p>
<p>For developing a minimal platform to start with, I chose not to include raylib or call into roc from zig. The main function in <code>platform/host.zig</code> printed <code>"hello,world"</code> just to test the platform built correctly.</p>
<h2 id="step2"><a href="#step2">Step 2 raylib library</a></h2>
<p>Next, I followed the instructions in <a href="https://github.com/ryupold/raylib.zig">https://github.com/ryupold/raylib.zig</a> to add raylib to the platform and implement the example from the README.</p>
<p>I updated <code>build.zig</code> and made minor changes so the libraries would build and link with roc. The main function in <code>platform/host.zig</code> was updated with the raylib example. It still didn't call into roc at this stage. </p>
<p>I wasn't able to get this working on my own, so I reached out to <a href="https://github.com/bhansconnect">Brendan Hansknecht</a>, who provided assistance with linking and missing symbols.</p>
<p>Below is the zig raylib example which I copied into my <code>platform/host.zig</code> alongside the other host functions like <code>roc_alloc</code> and <code>roc_panic</code>. Running the app with <code>roc dev</code> displayed the raylib example in a window with <code>"hello world!"</code> printed in yellow text.</p>
<pre><samp><span class="source c"><span class="comment line double-slash c"><span class="punctuation definition comment c">//</span> other functions above like roc_alloc, roc_dealloc, roc_panic etc 
</span><span class="comment line double-slash c"><span class="punctuation definition comment c">//</span> copied from platform-switching example
</span><span class="comment line double-slash c"><span class="punctuation definition comment c">//</span> ... 
</span>
<span class="storage modifier c">const</span> raylib <span class="keyword operator assignment c">=</span> @<span class="meta function-call c"><span class="variable function c">import</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"><span class="meta group c"><span class="string quoted double c"><span class="punctuation definition string begin c">&quot;</span>raylib<span class="punctuation definition string end c">&quot;</span></span></span></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span><span class="punctuation terminator c">;</span>

pub fn <span class="meta function c"><span class="entity name function c">main</span></span><span class="meta function parameters c"><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function parameters c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span><span class="meta function c"> </span><span class="storage type c">void</span> <span class="meta block c"><span class="punctuation section block begin c">{</span>
    raylib<span class="punctuation accessor c">.</span><span class="meta function-call c"><span class="variable function c">SetConfigFlags</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"><span class="meta group c">raylib<span class="punctuation accessor c">.</span><span class="variable other member c">ConfigFlags</span><span class="meta block c"><span class="punctuation section block begin c">{</span> <span class="punctuation accessor c">.</span><span class="variable other member c">FLAG_WINDOW_RESIZABLE</span> <span class="keyword operator assignment c">=</span> <span class="constant language c">true</span> <span class="punctuation section block end c">}</span></span></span></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span><span class="punctuation terminator c">;</span>
    raylib<span class="punctuation accessor c">.</span><span class="meta function-call c"><span class="variable function c">InitWindow</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"><span class="meta group c"><span class="constant numeric c">800</span><span class="punctuation separator c">,</span> <span class="constant numeric c">800</span><span class="punctuation separator c">,</span> <span class="string quoted double c"><span class="punctuation definition string begin c">&quot;</span>hello world!<span class="punctuation definition string end c">&quot;</span></span></span></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span><span class="punctuation terminator c">;</span>
    raylib<span class="punctuation accessor c">.</span><span class="meta function-call c"><span class="variable function c">SetTargetFPS</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"><span class="meta group c"><span class="constant numeric c">60</span></span></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span><span class="punctuation terminator c">;</span>

    defer raylib<span class="punctuation accessor c">.</span><span class="meta function-call c"><span class="variable function c">CloseWindow</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span><span class="punctuation terminator c">;</span>

    <span class="keyword control c">while</span> <span class="meta group c"><span class="punctuation section group begin c">(</span><span class="keyword operator arithmetic c">!</span>raylib<span class="punctuation accessor c">.</span><span class="meta function-call c"><span class="variable function c">WindowShouldClose</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span><span class="punctuation section group end c">)</span></span> <span class="meta block c"><span class="punctuation section block begin c">{</span>
        raylib<span class="punctuation accessor c">.</span><span class="meta function-call c"><span class="variable function c">BeginDrawing</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span><span class="punctuation terminator c">;</span>
        defer raylib<span class="punctuation accessor c">.</span><span class="meta function-call c"><span class="variable function c">EndDrawing</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span><span class="punctuation terminator c">;</span>
        
        raylib<span class="punctuation accessor c">.</span><span class="meta function-call c"><span class="variable function c">ClearBackground</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"><span class="meta group c">raylib<span class="punctuation accessor c">.</span><span class="variable other member c">BLACK</span></span></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span><span class="punctuation terminator c">;</span>
        raylib<span class="punctuation accessor c">.</span><span class="meta function-call c"><span class="variable function c">DrawFPS</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"><span class="meta group c"><span class="constant numeric c">10</span><span class="punctuation separator c">,</span> <span class="constant numeric c">10</span></span></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span><span class="punctuation terminator c">;</span>

        raylib<span class="punctuation accessor c">.</span><span class="meta function-call c"><span class="variable function c">DrawText</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"><span class="meta group c"><span class="string quoted double c"><span class="punctuation definition string begin c">&quot;</span>hello world!<span class="punctuation definition string end c">&quot;</span></span><span class="punctuation separator c">,</span> <span class="constant numeric c">100</span><span class="punctuation separator c">,</span> <span class="constant numeric c">100</span><span class="punctuation separator c">,</span> <span class="constant numeric c">20</span><span class="punctuation separator c">,</span> raylib<span class="punctuation accessor c">.</span><span class="variable other member c">YELLOW</span></span></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span><span class="punctuation terminator c">;</span>
    <span class="punctuation section block end c">}</span></span>
<span class="punctuation section block end c">}</span></span>
</span></pre></samp>
<p>The roc app and platform API weren't doing anything useful at this stage. I had a script to build my platform into a static library. Roc could build the app and link it with the platform. The app displayed the raylib example in a window. However, the host wasn't actually calling into roc.</p>
<h2 id="step3"><a href="#step3">Step 3 roc &lt;-&gt; host interface</a></h2>
<p>The <code>mainForHost</code> function in <code>platform/main.roc</code> defines the interface between roc and the zig host. I copied the platform, including both the roc and zig parts, from <a href="https://github.com/lukewilliamboswell/roc-wasm4">roc-wasm4</a>. This meant I was able to re-use these implementations for calling into roc in <code>platform/host.zig</code>.</p>
<p>The zig host is responsible for calling <code>roc__mainForHost_1_exposed_generic</code> which is generated by roc and returns a struct containing two functions <code>init</code> and <code>update</code>. This is defined in <code>platform/main.roc</code> and represents the interface between roc and the host.</p>
<p><em>Note the design for platforms is currently evolving, so how this is done in future may change significantly.</em></p>
<pre><samp><span class="upperident">ProgramForHost</span><span class="kw"> :</span><span class="delimeter"> {</span><span class="lowerident">
    init</span><span class="kw"> :</span><span class="upperident"> Task</span><span class="delimeter"> (</span><span class="upperident">Box</span><span class="upperident"> Model</span><span class="delimeter">)</span><span class="delimeter"> [</span><span class="delimeter">]</span><span class="delimeter">,</span><span class="lowerident">
    update</span><span class="kw"> :</span><span class="upperident"> Box</span><span class="upperident"> Model</span><span class="kw"> -&gt;</span><span class="upperident"> Task</span><span class="delimeter"> (</span><span class="upperident">Box</span><span class="upperident"> Model</span><span class="delimeter">)</span><span class="delimeter"> [</span><span class="delimeter">]</span><span class="delimeter">,</span><span class="delimeter">
}</span><span class="lowerident">

mainForHost</span><span class="kw"> :</span><span class="upperident"> ProgramForHost</span><span class="lowerident">
mainForHost</span><span class="kw"> =</span><span class="delimeter"> {</span><span class="lowerident"> init</span><span class="delimeter">,</span><span class="lowerident"> update</span><span class="delimeter"> }</span></samp></pre>
<p>Both of the functions in <code>ProgramForHost</code> provide a boxed representation of the app's <code>Model</code> to the host. Boxing the model stores the <code>Model</code> on the heap which enables roc to provide the host with an opaque pointer to the the <code>Model</code>. </p>
<p>The platform is unable to know the size or shape of <code>Model</code>, as this is defined in the application and provided to the platform. The host receives a pointer to a <code>Model</code> by calling <code>init</code>, which it can then pass back to roc in a future call to <code>update</code>. This is how a roc application is able to retain the state between calls.</p>
<h2 id="glue-llvm"><a href="#glue-llvm">Glue &amp; LLVM IR</a></h2>
<p>In the future platform authors will use <code>roc glue</code> to generate all of the relevant types and glue code for their platform, including the roc builtins (or standard library). However, this feature is still in development and there isn't a glue-spec written for zig yet.</p>
<p>So, in the interim, I found it useful to generate the LLVM IR representation for a platform by running <code>roc build --emit-llvm-ir --no-link examples/gui-counter.roc</code>. This produces a <code>gui-counter.ll</code> file which contains the IR for the application and platform without the host.</p>
<p>For example, the generated LLVM IR for <code>roc__mainForHost_1_exposed_generic</code> is:</p>
<pre><samp><span class="source c">define <span class="storage type c">void</span> @<span class="meta function-call c"><span class="variable function c">roc__mainForHost_1_exposed_generic</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"><span class="meta group c">ptr <span class="keyword operator arithmetic c">%</span><span class="constant numeric c">0</span></span></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span> <span class="keyword operator arithmetic c">!</span>dbg <span class="keyword operator arithmetic c">!</span><span class="constant numeric c">667</span> <span class="meta block c"><span class="punctuation section block begin c">{</span>
<span class="entity name label c">entry</span><span class="punctuation separator c">:</span>
  <span class="keyword operator arithmetic c">%</span>call <span class="keyword operator assignment c">=</span> call fastcc <span class="meta block c"><span class="punctuation section block begin c">{</span> <span class="meta block c"><span class="punctuation section block begin c">{</span> <span class="meta block c"><span class="punctuation section block begin c">{</span> <span class="meta block c"><span class="punctuation section block begin c">{</span> <span class="meta block c"><span class="punctuation section block begin c">{</span> i32<span class="punctuation separator c">,</span> i32 <span class="punctuation section block end c">}</span></span><span class="punctuation separator c">,</span> <span class="meta block c"><span class="punctuation section block begin c">{</span><span class="punctuation section block end c">}</span></span> <span class="punctuation section block end c">}</span></span><span class="punctuation separator c">,</span> <span class="meta block c"><span class="punctuation section block begin c">{</span><span class="punctuation section block end c">}</span></span> <span class="punctuation section block end c">}</span></span><span class="punctuation separator c">,</span> <span class="meta block c"><span class="punctuation section block begin c">{</span><span class="punctuation section block end c">}</span></span> <span class="punctuation section block end c">}</span></span><span class="punctuation separator c">,</span> <span class="meta block c"><span class="punctuation section block begin c">{</span><span class="punctuation section block end c">}</span></span> <span class="punctuation section block end c">}</span></span> @<span class="meta function-call c"><span class="variable function c">_mainForHost_99c9f773566b1d5d689233ef7949cf16c8797c970a4668678361d8c89d24f20</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span><span class="punctuation separator c">,</span> <span class="keyword operator arithmetic c">!</span>dbg <span class="keyword operator arithmetic c">!</span><span class="constant numeric c">668</span>
  store <span class="meta block c"><span class="punctuation section block begin c">{</span> <span class="meta block c"><span class="punctuation section block begin c">{</span> <span class="meta block c"><span class="punctuation section block begin c">{</span> <span class="meta block c"><span class="punctuation section block begin c">{</span> <span class="meta block c"><span class="punctuation section block begin c">{</span> i32<span class="punctuation separator c">,</span> i32 <span class="punctuation section block end c">}</span></span><span class="punctuation separator c">,</span> <span class="meta block c"><span class="punctuation section block begin c">{</span><span class="punctuation section block end c">}</span></span> <span class="punctuation section block end c">}</span></span><span class="punctuation separator c">,</span> <span class="meta block c"><span class="punctuation section block begin c">{</span><span class="punctuation section block end c">}</span></span> <span class="punctuation section block end c">}</span></span><span class="punctuation separator c">,</span> <span class="meta block c"><span class="punctuation section block begin c">{</span><span class="punctuation section block end c">}</span></span> <span class="punctuation section block end c">}</span></span><span class="punctuation separator c">,</span> <span class="meta block c"><span class="punctuation section block begin c">{</span><span class="punctuation section block end c">}</span></span> <span class="punctuation section block end c">}</span></span> <span class="keyword operator arithmetic c">%</span>call<span class="punctuation separator c">,</span> ptr <span class="keyword operator arithmetic c">%</span><span class="constant numeric c">0</span><span class="punctuation separator c">,</span> align <span class="constant numeric c">4</span><span class="punctuation separator c">,</span> <span class="keyword operator arithmetic c">!</span>dbg <span class="keyword operator arithmetic c">!</span><span class="constant numeric c">668</span>
  ret <span class="storage type c">void</span><span class="punctuation separator c">,</span> <span class="keyword operator arithmetic c">!</span>dbg <span class="keyword operator arithmetic c">!</span><span class="constant numeric c">668</span>
<span class="punctuation section block end c">}</span></span>
</span></pre></samp>
<p>Which is represented in <code>platform/host.zig</code> as:</p>
<pre><samp><span class="source c"><span class="storage modifier c">extern</span> fn <span class="meta function c"><span class="entity name function c">roc__mainForHost_1_exposed_generic</span></span><span class="meta function parameters c"><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function parameters c"><span class="meta group c"><span class="keyword operator c">*</span><span class="variable parameter c">anyopaque</span><span class="punctuation section group end c">)</span></span></span><span class="meta function c"> </span><span class="meta function-call c"><span class="variable function c">callconv</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation accessor c">.</span><span class="variable other member c">C</span></span></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span> <span class="storage type c">void</span><span class="punctuation terminator c">;</span>
</span></pre></samp>
<p>By inspecting the LLVM IR I could see the shape of the generated functions and thier implementation for LLVM which assisted me with extern definitions in the platform.</p>
<h2 id="step4"><a href="#step4">Step 4 calling roc</a></h2>
<p>I implementated the calls into roc in <code>platform/host.zig</code> as follows:</p>
<pre><samp><span class="source c"><span class="comment line double-slash c"><span class="punctuation definition comment c">//</span> MODEL
</span>var model<span class="keyword operator ternary c">:</span> <span class="keyword operator c">*</span>anyopaque <span class="keyword operator assignment c">=</span> undefined<span class="punctuation terminator c">;</span>

<span class="comment line double-slash c"><span class="punctuation definition comment c">//</span> CALL ROC INIT
</span><span class="storage modifier c">const</span> size <span class="keyword operator assignment c">=</span> @<span class="meta function-call c"><span class="variable function c">as</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"><span class="meta group c">usize<span class="punctuation separator c">,</span> @<span class="meta function-call c"><span class="variable function c">intCast</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"><span class="meta group c"><span class="meta function-call c"><span class="variable function c">roc__mainForHost_1_exposed_size</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span></span></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span></span></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span><span class="punctuation terminator c">;</span>
<span class="storage modifier c">const</span> captures <span class="keyword operator assignment c">=</span> <span class="meta function-call c"><span class="variable function c">roc_alloc</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"><span class="meta group c">size<span class="punctuation separator c">,</span> @<span class="meta function-call c"><span class="variable function c">alignOf</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"><span class="meta group c">u128</span></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span></span></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span><span class="punctuation terminator c">;</span>
defer <span class="meta function c"><span class="entity name function c">roc_dealloc</span></span><span class="meta function parameters c"><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function parameters c"><span class="meta group c"><span class="variable parameter c">captures</span><span class="punctuation separator c">,</span> @<span class="meta function-call c"><span class="variable function c">alignOf</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"><span class="meta group c">u128</span></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span><span class="punctuation section group end c">)</span></span></span><span class="punctuation terminator c">;</span>

<span class="meta function-call c"><span class="variable function c">roc__mainForHost_1_exposed_generic</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"><span class="meta group c">captures</span><span class="meta group c"><span class="punctuation section group end c">)</span></span></span><span class="punctuation terminator c">;</span>
<span class="meta function-call c"><span class="variable function c">roc__mainForHost_0_caller</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"><span class="meta group c">undefined<span class="punctuation separator c">,</span> captures<span class="punctuation separator c">,</span> <span class="keyword operator c">&amp;</span>model</span><span class="meta group c"><span class="punctuation section group end c">)</span></span></span><span class="punctuation terminator c">;</span>

<span class="storage modifier c">const</span> update_task_size <span class="keyword operator assignment c">=</span> @<span class="meta function-call c"><span class="variable function c">as</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"><span class="meta group c">usize<span class="punctuation separator c">,</span> @<span class="meta function-call c"><span class="variable function c">intCast</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"><span class="meta group c"><span class="meta function-call c"><span class="variable function c">roc__mainForHost_2_size</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span></span></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span></span></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span><span class="punctuation terminator c">;</span>
var update_captures <span class="keyword operator assignment c">=</span> <span class="meta function-call c"><span class="variable function c">roc_alloc</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"><span class="meta group c">update_task_size<span class="punctuation separator c">,</span> @<span class="meta function-call c"><span class="variable function c">alignOf</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"><span class="meta group c">u128</span></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span></span></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span><span class="punctuation terminator c">;</span>

<span class="comment line double-slash c"><span class="punctuation definition comment c">//</span> CALL ROC UPDATE
</span><span class="meta function-call c"><span class="variable function c">roc__mainForHost_1_caller</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"><span class="meta group c"><span class="keyword operator c">&amp;</span>model<span class="punctuation separator c">,</span> undefined<span class="punctuation separator c">,</span> update_captures</span><span class="meta group c"><span class="punctuation section group end c">)</span></span></span><span class="punctuation terminator c">;</span>
<span class="meta function-call c"><span class="variable function c">roc__mainForHost_2_caller</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"><span class="meta group c">undefined<span class="punctuation separator c">,</span> update_captures<span class="punctuation separator c">,</span> <span class="keyword operator c">&amp;</span>model</span><span class="meta group c"><span class="punctuation section group end c">)</span></span></span><span class="punctuation terminator c">;</span>
</span></pre></samp>
<p>I only have a surface-level appreciation for how this works, so I am not going to try and explain it any further here. However, I have always found people in the beginner channel on roc zulip to be friendly and helpful whenever I ask any questions. </p>
<p>Thank you to <a href="https://github.com/bhansconnect">Brendan Hansknecht</a> for helping me with this. </p>
<h2 id="step5"><a href="#step5">Step 5 adding an effect</a></h2>
<p>To confirm roc was being called correctly, and that it could work with raylib I needed an <code>Effect</code>. </p>
<p>I chose to give roc the ability to set the window size, as this looked relatively simple to implement. So, first I added the effect in the platform. </p>
<p>From an application author's perspective, this looks like a function that returns a <code>Task</code> that cannot fail and returns the empty <code>{}</code> value. Within the platform, this is implemented using an <code>Effect</code>.</p>
<pre><samp><span class="comment"># platform/Effect.roc</span><span class="lowerident">
setWindowSize</span><span class="kw"> :</span><span class="upperident"> I32</span><span class="delimeter">,</span><span class="upperident"> I32</span><span class="kw"> -&gt;</span><span class="upperident"> Effect</span><span class="delimeter"> {</span><span class="delimeter">}</span><span class="comment">

# platform/Task.roc, since moved to platform/Core.roc</span><span class="lowerident">
setWindowSize</span><span class="kw"> :</span><span class="delimeter"> {</span><span class="lowerident"> width</span><span class="kw"> :</span><span class="upperident"> F32</span><span class="delimeter">,</span><span class="lowerident"> height</span><span class="kw"> :</span><span class="upperident"> F32</span><span class="delimeter"> }</span><span class="kw"> -&gt;</span><span class="upperident"> Task</span><span class="delimeter"> {</span><span class="delimeter">}</span><span class="delimeter"> [</span><span class="delimeter">]</span><span class="lowerident">
setWindowSize</span><span class="kw"> =</span><span class="kw"> \</span><span class="delimeter">{</span><span class="lowerident"> width</span><span class="delimeter">,</span><span class="lowerident"> height</span><span class="delimeter"> }</span><span class="kw"> -&gt;</span><span class="upperident">
    Effect</span><span class="delimeter">.</span><span class="lowerident">setWindowSize</span><span class="delimeter"> (</span><span class="upperident">Num</span><span class="delimeter">.</span><span class="lowerident">round</span><span class="lowerident"> width</span><span class="delimeter">)</span><span class="delimeter"> (</span><span class="upperident">Num</span><span class="delimeter">.</span><span class="lowerident">round</span><span class="lowerident"> height</span><span class="delimeter">)</span><span class="kw">
    |&gt;</span><span class="upperident"> Effect</span><span class="delimeter">.</span><span class="lowerident">map</span><span class="upperident"> Ok</span><span class="kw">
    |&gt;</span><span class="upperident"> InternalTask</span><span class="delimeter">.</span><span class="lowerident">fromEffect</span></samp></pre>
<p>This is how it is used in the demo application.</p>
<pre><samp><span class="lowerident">init</span><span class="kw"> :</span><span class="upperident"> Task</span><span class="upperident"> Model</span><span class="delimeter"> [</span><span class="delimeter">]</span><span class="lowerident">
init</span><span class="kw"> =</span><span class="delimeter">

    {</span><span class="delimeter">}</span><span class="kw"> &lt;-</span><span class="upperident"> Core</span><span class="delimeter">.</span><span class="lowerident">setWindowSize</span><span class="delimeter"> {</span><span class="lowerident"> width</span><span class="delimeter">,</span><span class="lowerident"> height</span><span class="delimeter"> }</span><span class="kw"> |&gt;</span><span class="upperident"> Task</span><span class="delimeter">.</span><span class="lowerident">await</span><span class="comment">

    # ... </span></samp></pre>
<p><em>Note the host receives two <code>I32</code> values which is what raylib requires. However, for application authors, I have exposed an API that expects two <code>F32</code> in a record. My hypothesis is that a record will be more explicit for what these arguments do, and <code>F32</code>'s will simplify using these values across the app without having a lot of calls to <code>Num.toI32</code> or <code>Num.toF32</code>.</em></p>
<p>Finally, this Effect is implemented in <code>platform/host.zig</code> so that roc will link against this and can call this function in the host.</p>
<pre><samp><span class="source c">export fn <span class="meta function c"><span class="entity name function c">roc_fx_setWindowSize</span></span><span class="meta function parameters c"><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function parameters c"><span class="meta group c">width<span class="keyword operator ternary c">:</span> <span class="variable parameter c">i32</span><span class="punctuation separator c">,</span> height<span class="keyword operator ternary c">:</span> <span class="variable parameter c">i32</span><span class="punctuation section group end c">)</span></span></span><span class="meta function c"> </span><span class="meta function-call c"><span class="variable function c">callconv</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation accessor c">.</span><span class="variable other member c">C</span></span></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span> <span class="storage type c">void</span> <span class="meta block c"><span class="punctuation section block begin c">{</span>
    raylib<span class="punctuation accessor c">.</span><span class="meta function-call c"><span class="variable function c">SetWindowSize</span><span class="meta group c"><span class="punctuation section group begin c">(</span></span></span><span class="meta function-call c"><span class="meta group c">width<span class="punctuation separator c">,</span> height</span></span><span class="meta function-call c"><span class="meta group c"><span class="punctuation section group end c">)</span></span></span><span class="punctuation terminator c">;</span>
<span class="punctuation section block end c">}</span></span>
</span></pre></samp>
<p>This is how roc will call into the host. Note that the host first calls into roc with <code>init</code> or <code>update</code>, and then these <code>Effect</code>s enable roc to call back into the host for impure operations like writing to a file, or requesting a change in window size.</p>
<h2 id="step6"><a href="#step6">Step 6 roc &lt;-&gt; roc interface</a></h2>
<p>The platform exposes an API for an application to interact with. The application provides an implementation and provides the types and functions required by the platform. This is the interface between the application and the platform and is defined in <code>platform/main.roc</code>.</p>
<p>For this platform the header part <code>requires { Model } { main : Program Model }</code>, indicates that the <code>Model</code> and <code>main</code> are to be provided by the application.</p>
<p>We define <code>Program state</code> in <code>platform/Core.roc</code> to the following, which is similar to the <code>ProgramForHost</code> described in <a href="#step3">Step 3 roc &lt;-&gt; host interface</a>, however now the <code>state</code> is a type variable instead of a boxed <code>Model</code>. </p>
<pre><samp><span class="upperident">Program</span><span class="lowerident"> state</span><span class="kw"> :</span><span class="delimeter"> {</span><span class="lowerident">
    init</span><span class="kw"> :</span><span class="upperident"> Task</span><span class="lowerident"> state</span><span class="delimeter"> [</span><span class="delimeter">]</span><span class="delimeter">,</span><span class="lowerident">
    render</span><span class="kw"> :</span><span class="lowerident"> state</span><span class="kw"> -&gt;</span><span class="upperident"> Task</span><span class="lowerident"> state</span><span class="delimeter"> [</span><span class="delimeter">]</span><span class="delimeter">,</span><span class="delimeter">
}</span></samp></pre>
<p>Here, the app provides two functions <code>init</code> and <code>render</code> to the platform. These both return a <code>Task Model []</code> which provides the <code>Model</code> that will be used in the next update.</p>
<p>In the demo application this is implemented as follows:</p>
<pre><samp><span class="comment"># examples/gui-counter.roc</span><span class="kw">
app</span><span class="literal"> "counter"</span><span class="comment">
    # ...</span><span class="kw">
    provides</span><span class="delimeter"> [</span><span class="lowerident">main</span><span class="delimeter">,</span><span class="upperident"> Model</span><span class="delimeter">]</span><span class="kw"> to</span><span class="lowerident"> ray</span><span class="comment"> # from application to platform</span><span class="comment">

# the application's state</span><span class="upperident">
Model</span><span class="kw"> :</span><span class="delimeter"> {</span><span class="lowerident"> left</span><span class="kw"> :</span><span class="upperident"> Counter</span><span class="delimeter">,</span><span class="lowerident"> middle</span><span class="kw"> :</span><span class="upperident"> Counter</span><span class="delimeter">,</span><span class="lowerident"> right</span><span class="kw"> :</span><span class="upperident"> Counter</span><span class="delimeter"> }</span><span class="comment">

# to the platform</span><span class="lowerident">
main</span><span class="kw"> :</span><span class="upperident"> Program</span><span class="upperident"> Model</span><span class="lowerident">
main</span><span class="kw"> =</span><span class="delimeter"> {</span><span class="lowerident"> init</span><span class="delimeter">,</span><span class="lowerident"> render</span><span class="delimeter"> }</span><span class="comment">

# returns a Model and does not fail </span><span class="lowerident">
init</span><span class="kw"> :</span><span class="upperident"> Task</span><span class="upperident"> Model</span><span class="delimeter"> [</span><span class="delimeter">]</span><span class="comment">

# takes a Model and returns a new Model</span><span class="lowerident">
render</span><span class="kw"> :</span><span class="upperident"> Model</span><span class="kw"> -&gt;</span><span class="upperident"> Task</span><span class="upperident"> Model</span><span class="delimeter"> [</span><span class="delimeter">]</span></samp></pre>
<p>Recall from earlier that the interface with the host, <code>ProgramForHost</code>, provides a boxed representation of the app's <code>Model</code>. This is achieved within the platform by transforming the <code>init</code> and <code>update</code> provided by the application as follows: </p>
<pre><samp><span class="comment"># platform/main.roc</span><span class="lowerident">
platform</span><span class="literal"> "roc-ray"</span><span class="lowerident">
    requires</span><span class="delimeter"> {</span><span class="upperident"> Model</span><span class="delimeter"> }</span><span class="delimeter"> {</span><span class="lowerident"> main</span><span class="kw"> :</span><span class="upperident"> Program</span><span class="upperident"> Model</span><span class="delimeter"> }</span><span class="comment"> # from application</span><span class="comment">
    # ...</span><span class="lowerident">
    provides</span><span class="delimeter"> [</span><span class="lowerident">mainForHost</span><span class="delimeter">]</span><span class="comment"> # to host</span><span class="comment">

# interface with the host</span><span class="upperident">
ProgramForHost</span><span class="kw"> :</span><span class="delimeter"> {</span><span class="lowerident">
    init</span><span class="kw"> :</span><span class="upperident"> Task</span><span class="delimeter"> (</span><span class="upperident">Box</span><span class="upperident"> Model</span><span class="delimeter">)</span><span class="delimeter"> [</span><span class="delimeter">]</span><span class="delimeter">,</span><span class="lowerident">
    update</span><span class="kw"> :</span><span class="upperident"> Box</span><span class="upperident"> Model</span><span class="kw"> -&gt;</span><span class="upperident"> Task</span><span class="delimeter"> (</span><span class="upperident">Box</span><span class="upperident"> Model</span><span class="delimeter">)</span><span class="delimeter"> [</span><span class="delimeter">]</span><span class="delimeter">,</span><span class="delimeter">
}</span><span class="lowerident">

mainForHost</span><span class="kw"> :</span><span class="upperident"> ProgramForHost</span><span class="lowerident">
mainForHost</span><span class="kw"> =</span><span class="delimeter"> {</span><span class="lowerident"> init</span><span class="delimeter">,</span><span class="lowerident"> update</span><span class="delimeter"> }</span><span class="comment">

# transform main.init provided by the application</span><span class="lowerident">
init</span><span class="kw"> :</span><span class="upperident"> Task</span><span class="delimeter"> (</span><span class="upperident">Box</span><span class="upperident"> Model</span><span class="delimeter">)</span><span class="delimeter"> [</span><span class="delimeter">]</span><span class="lowerident">
init</span><span class="kw"> =</span><span class="lowerident"> main</span><span class="delimeter">.</span><span class="lowerident">init</span><span class="kw"> |&gt;</span><span class="upperident"> Task</span><span class="delimeter">.</span><span class="lowerident">map</span><span class="upperident"> Box</span><span class="delimeter">.</span><span class="lowerident">box</span><span class="comment">

# transform main.render provided by the application</span><span class="lowerident">
update</span><span class="kw"> :</span><span class="upperident"> Box</span><span class="upperident"> Model</span><span class="kw"> -&gt;</span><span class="upperident"> Task</span><span class="delimeter"> (</span><span class="upperident">Box</span><span class="upperident"> Model</span><span class="delimeter">)</span><span class="delimeter"> [</span><span class="delimeter">]</span><span class="lowerident">
update</span><span class="kw"> =</span><span class="kw"> \</span><span class="lowerident">boxedModel</span><span class="kw"> -&gt;</span><span class="lowerident">
    boxedModel</span><span class="kw">
    |&gt;</span><span class="upperident"> Box</span><span class="delimeter">.</span><span class="lowerident">unbox</span><span class="kw">
    |&gt;</span><span class="lowerident"> main</span><span class="delimeter">.</span><span class="lowerident">render</span><span class="kw">
    |&gt;</span><span class="upperident"> Task</span><span class="delimeter">.</span><span class="lowerident">map</span><span class="upperident"> Box</span><span class="delimeter">.</span><span class="lowerident">box</span></samp></pre>
<p>Note the model is unboxed and then boxed when calling the <code>render</code> provided by the application.</p>
<h2 id="reflection"><a href="#reflection">Reflection</a></h2>
<p>I have enjoyed building this platform and am pleasantly surprised that this works as well as it does. I've learnt a lot about roc and platform development.</p>
<p>The raylib functionality is limited to just a handful of calls, so there is still a lot of work to produce something that utilises the available capability within the library. </p>
<p>The Action-State implementation is very minimal with significant aspects that still need to be explored.</p>
<p>Further work could include;</p>
<ul>
<li>an API that is effect agnostic and works e.g. both native desktop and editor plugins </li>
<li>performance optimisations</li>
<li>state change in a child affecting the state of a parent</li>
<li>modify the API and implement something like <code>fromTask : Task ok err, (Result ok err -> (Result state [Removed]* -> Action state)) -> Action state</code> to run tasks asynchronously in event handlers instead of the update Fn</li>
</ul>
<p>Thank you for reading. Please let me know if you have enjoyed this or would like to assist with further exploration using this platform.</p>
<h2 id="source"><a href="#source">Source code</a></h2>
<p><em>full source code at <a href="https://github.com/lukewilliamboswell/roc-ray">https://github.com/lukewilliamboswell/roc-ray</a></em> </p>
<p>Below is a copy of the demo application at the time of writing.</p>
<pre><samp><span class="comment"># gui-counter.roc</span><span class="kw">
app</span><span class="literal"> "counter"</span><span class="kw">
    packages</span><span class="delimeter"> {</span><span class="lowerident"> ray</span><span class="kw">:</span><span class="literal"> "../platform/main.roc"</span><span class="delimeter"> }</span><span class="kw">
    imports</span><span class="delimeter"> [</span><span class="lowerident">
        ray</span><span class="delimeter">.</span><span class="upperident">Task</span><span class="delimeter">.</span><span class="delimeter">{</span><span class="upperident"> Task</span><span class="delimeter"> }</span><span class="delimeter">,</span><span class="lowerident">
        ray</span><span class="delimeter">.</span><span class="upperident">Action</span><span class="delimeter">.</span><span class="delimeter">{</span><span class="upperident"> Action</span><span class="delimeter"> }</span><span class="delimeter">,</span><span class="lowerident">
        ray</span><span class="delimeter">.</span><span class="upperident">Core</span><span class="delimeter">.</span><span class="delimeter">{</span><span class="upperident"> Program</span><span class="delimeter">,</span><span class="upperident"> Color</span><span class="delimeter">,</span><span class="upperident"> Rectangle</span><span class="delimeter"> }</span><span class="delimeter">,</span><span class="lowerident">
        ray</span><span class="delimeter">.</span><span class="upperident">GUI</span><span class="delimeter">.</span><span class="delimeter">{</span><span class="upperident"> Elem</span><span class="delimeter"> }</span><span class="delimeter">,</span><span class="upperident">
        Counter</span><span class="delimeter">.</span><span class="delimeter">{</span><span class="upperident"> Counter</span><span class="delimeter"> }</span><span class="delimeter">,</span><span class="delimeter">
    ]</span><span class="kw">
    provides</span><span class="delimeter"> [</span><span class="lowerident">main</span><span class="delimeter">,</span><span class="upperident"> Model</span><span class="delimeter">]</span><span class="kw"> to</span><span class="lowerident"> ray</span><span class="upperident">

Model</span><span class="kw"> :</span><span class="delimeter"> {</span><span class="lowerident">
    left</span><span class="kw"> :</span><span class="upperident"> Counter</span><span class="delimeter">,</span><span class="lowerident">
    middle</span><span class="kw"> :</span><span class="upperident"> Counter</span><span class="delimeter">,</span><span class="lowerident">
    right</span><span class="kw"> :</span><span class="upperident"> Counter</span><span class="delimeter">,</span><span class="delimeter">
}</span><span class="lowerident">

main</span><span class="kw"> :</span><span class="upperident"> Program</span><span class="upperident"> Model</span><span class="lowerident">
main</span><span class="kw"> =</span><span class="delimeter"> {</span><span class="lowerident"> init</span><span class="delimeter">,</span><span class="lowerident"> render</span><span class="delimeter"> }</span><span class="lowerident">

init</span><span class="kw"> :</span><span class="upperident"> Task</span><span class="upperident"> Model</span><span class="delimeter"> [</span><span class="delimeter">]</span><span class="lowerident">
init</span><span class="kw"> =</span><span class="delimeter">

    {</span><span class="delimeter">}</span><span class="kw"> &lt;-</span><span class="upperident"> Core</span><span class="delimeter">.</span><span class="lowerident">setWindowSize</span><span class="delimeter"> {</span><span class="lowerident"> width</span><span class="delimeter">,</span><span class="lowerident"> height</span><span class="delimeter"> }</span><span class="kw"> |&gt;</span><span class="upperident"> Task</span><span class="delimeter">.</span><span class="lowerident">await</span><span class="delimeter">
    {</span><span class="delimeter">}</span><span class="kw"> &lt;-</span><span class="upperident"> Core</span><span class="delimeter">.</span><span class="lowerident">setWindowTitle</span><span class="literal"> "GUI Counter demo"</span><span class="kw"> |&gt;</span><span class="upperident"> Task</span><span class="delimeter">.</span><span class="lowerident">await</span><span class="upperident">

    Task</span><span class="delimeter">.</span><span class="lowerident">ok</span><span class="delimeter"> {</span><span class="lowerident">
        left</span><span class="kw">:</span><span class="upperident"> Counter</span><span class="delimeter">.</span><span class="lowerident">init</span><span class="literal"> 10</span><span class="delimeter">,</span><span class="lowerident">
        middle</span><span class="kw">:</span><span class="upperident"> Counter</span><span class="delimeter">.</span><span class="lowerident">init</span><span class="literal"> 20</span><span class="delimeter">,</span><span class="lowerident">
        right</span><span class="kw">:</span><span class="upperident"> Counter</span><span class="delimeter">.</span><span class="lowerident">init</span><span class="literal"> 30</span><span class="delimeter">,</span><span class="delimeter">
    }</span><span class="lowerident">

render</span><span class="kw"> :</span><span class="upperident"> Model</span><span class="kw"> -&gt;</span><span class="upperident"> Task</span><span class="upperident"> Model</span><span class="delimeter"> [</span><span class="delimeter">]</span><span class="lowerident">
render</span><span class="kw"> =</span><span class="kw"> \</span><span class="lowerident">model</span><span class="kw"> -&gt;</span><span class="comment">

    # this is a temporary workaround for a bug `Error in alias analysis: error in module...`</span><span class="comment">
    # sometimes we need an extra Task in the chain to prevent this error</span><span class="lowerident">
    _</span><span class="kw"> &lt;-</span><span class="upperident"> Core</span><span class="delimeter">.</span><span class="lowerident">getMousePosition</span><span class="kw"> |&gt;</span><span class="upperident"> Task</span><span class="delimeter">.</span><span class="lowerident">await</span><span class="upperident">
    
    GUI</span><span class="delimeter">.</span><span class="lowerident">col</span><span class="delimeter"> [</span><span class="upperident">
        GUI</span><span class="delimeter">.</span><span class="lowerident">text</span><span class="delimeter"> {</span><span class="lowerident"> label</span><span class="kw">:</span><span class="literal"> "Click below to change the counters, press ESC to exit"</span><span class="delimeter">,</span><span class="lowerident"> color</span><span class="kw">:</span><span class="lowerident"> black</span><span class="delimeter"> }</span><span class="delimeter">,</span><span class="upperident">
        GUI</span><span class="delimeter">.</span><span class="lowerident">row</span><span class="delimeter"> [</span><span class="upperident">
            GUI</span><span class="delimeter">.</span><span class="lowerident">translate</span><span class="delimeter"> (</span><span class="upperident">Counter</span><span class="delimeter">.</span><span class="lowerident">render</span><span class="lowerident"> model</span><span class="delimeter">.</span><span class="lowerident">left</span><span class="lowerident"> red</span><span class="delimeter">)</span><span class="delimeter"> .</span><span class="lowerident">left</span><span class="kw"> \</span><span class="lowerident">record</span><span class="delimeter">,</span><span class="lowerident"> count</span><span class="kw"> -&gt;</span><span class="delimeter"> {</span><span class="lowerident"> record</span><span class="kw"> &amp;</span><span class="lowerident"> left</span><span class="kw">:</span><span class="lowerident"> count</span><span class="delimeter"> }</span><span class="delimeter">,</span><span class="upperident">
            GUI</span><span class="delimeter">.</span><span class="lowerident">translate</span><span class="delimeter"> (</span><span class="upperident">Counter</span><span class="delimeter">.</span><span class="lowerident">render</span><span class="lowerident"> model</span><span class="delimeter">.</span><span class="lowerident">middle</span><span class="lowerident"> green</span><span class="delimeter">)</span><span class="delimeter"> .</span><span class="lowerident">middle</span><span class="kw"> \</span><span class="lowerident">record</span><span class="delimeter">,</span><span class="lowerident"> count</span><span class="kw"> -&gt;</span><span class="delimeter"> {</span><span class="lowerident"> record</span><span class="kw"> &amp;</span><span class="lowerident"> middle</span><span class="kw">:</span><span class="lowerident"> count</span><span class="delimeter"> }</span><span class="delimeter">,</span><span class="upperident">
            GUI</span><span class="delimeter">.</span><span class="lowerident">translate</span><span class="delimeter"> (</span><span class="upperident">Counter</span><span class="delimeter">.</span><span class="lowerident">render</span><span class="lowerident"> model</span><span class="delimeter">.</span><span class="lowerident">right</span><span class="lowerident"> blue</span><span class="delimeter">)</span><span class="delimeter"> .</span><span class="lowerident">right</span><span class="kw"> \</span><span class="lowerident">record</span><span class="delimeter">,</span><span class="lowerident"> count</span><span class="kw"> -&gt;</span><span class="delimeter"> {</span><span class="lowerident"> record</span><span class="kw"> &amp;</span><span class="lowerident"> right</span><span class="kw">:</span><span class="lowerident"> count</span><span class="delimeter"> }</span><span class="delimeter">,</span><span class="delimeter">
        ]</span><span class="delimeter">,</span><span class="delimeter">
    ]</span><span class="kw">
    |&gt;</span><span class="upperident"> GUI</span><span class="delimeter">.</span><span class="lowerident">window</span><span class="delimeter"> {</span><span class="lowerident"> title</span><span class="kw">:</span><span class="literal"> "Window"</span><span class="delimeter">,</span><span class="lowerident"> onClose</span><span class="kw">:</span><span class="kw"> \</span><span class="lowerident">_</span><span class="kw"> -&gt;</span><span class="upperident"> Action</span><span class="delimeter">.</span><span class="lowerident">none</span><span class="delimeter"> }</span><span class="kw">
    |&gt;</span><span class="upperident"> GUI</span><span class="delimeter">.</span><span class="lowerident">draw</span><span class="lowerident"> model</span><span class="delimeter"> {</span><span class="lowerident">
        x</span><span class="kw">:</span><span class="lowerident"> width</span><span class="op"> /</span><span class="literal"> 8</span><span class="delimeter">,</span><span class="lowerident">
        y</span><span class="kw">:</span><span class="lowerident"> height</span><span class="op"> /</span><span class="literal"> 8</span><span class="delimeter">,</span><span class="lowerident">
        width</span><span class="kw">:</span><span class="lowerident"> width</span><span class="op"> *</span><span class="literal"> 6</span><span class="op"> /</span><span class="literal"> 8</span><span class="delimeter">,</span><span class="lowerident">
        height</span><span class="kw">:</span><span class="lowerident"> height</span><span class="op"> *</span><span class="literal"> 6</span><span class="op"> /</span><span class="literal"> 8</span><span class="delimeter">,</span><span class="delimeter">
    }</span><span class="lowerident">

width</span><span class="kw"> =</span><span class="literal"> 800</span><span class="lowerident">
height</span><span class="kw"> =</span><span class="literal"> 600</span><span class="lowerident">
black</span><span class="kw"> =</span><span class="delimeter"> {</span><span class="lowerident"> r</span><span class="kw">:</span><span class="literal"> 0</span><span class="delimeter">,</span><span class="lowerident"> g</span><span class="kw">:</span><span class="literal"> 0</span><span class="delimeter">,</span><span class="lowerident"> b</span><span class="kw">:</span><span class="literal"> 0</span><span class="delimeter">,</span><span class="lowerident"> a</span><span class="kw">:</span><span class="literal"> 255</span><span class="delimeter"> }</span><span class="lowerident">
blue</span><span class="kw"> =</span><span class="delimeter"> {</span><span class="lowerident"> r</span><span class="kw">:</span><span class="literal"> 29</span><span class="delimeter">,</span><span class="lowerident"> g</span><span class="kw">:</span><span class="literal"> 66</span><span class="delimeter">,</span><span class="lowerident"> b</span><span class="kw">:</span><span class="literal"> 137</span><span class="delimeter">,</span><span class="lowerident"> a</span><span class="kw">:</span><span class="literal"> 255</span><span class="delimeter"> }</span><span class="lowerident">
red</span><span class="kw"> =</span><span class="delimeter"> {</span><span class="lowerident"> r</span><span class="kw">:</span><span class="literal"> 211</span><span class="delimeter">,</span><span class="lowerident"> g</span><span class="kw">:</span><span class="literal"> 39</span><span class="delimeter">,</span><span class="lowerident"> b</span><span class="kw">:</span><span class="literal"> 62</span><span class="delimeter">,</span><span class="lowerident"> a</span><span class="kw">:</span><span class="literal"> 255</span><span class="delimeter"> }</span><span class="lowerident">
green</span><span class="kw"> =</span><span class="delimeter"> {</span><span class="lowerident"> r</span><span class="kw">:</span><span class="literal"> 0</span><span class="delimeter">,</span><span class="lowerident"> g</span><span class="kw">:</span><span class="literal"> 59</span><span class="delimeter">,</span><span class="lowerident"> b</span><span class="kw">:</span><span class="literal"> 73</span><span class="delimeter">,</span><span class="lowerident"> a</span><span class="kw">:</span><span class="literal"> 255</span><span class="delimeter"> }</span></samp></pre><pre><samp><span class="comment"># Counter.roc</span><span class="kw">
interface</span><span class="upperident"> Counter</span><span class="kw">
    exposes</span><span class="delimeter"> [</span><span class="upperident">Counter</span><span class="delimeter">,</span><span class="lowerident"> init</span><span class="delimeter">,</span><span class="lowerident"> render</span><span class="delimeter">]</span><span class="kw">
    imports</span><span class="delimeter"> [</span><span class="lowerident">ray</span><span class="delimeter">.</span><span class="upperident">Action</span><span class="delimeter">.</span><span class="delimeter">{</span><span class="upperident"> Action</span><span class="delimeter"> }</span><span class="delimeter">,</span><span class="lowerident"> ray</span><span class="delimeter">.</span><span class="upperident">Core</span><span class="delimeter">.</span><span class="delimeter">{</span><span class="upperident"> Color</span><span class="delimeter"> }</span><span class="delimeter">,</span><span class="lowerident"> ray</span><span class="delimeter">.</span><span class="upperident">GUI</span><span class="delimeter">.</span><span class="delimeter">{</span><span class="upperident"> Elem</span><span class="delimeter"> }</span><span class="delimeter">]</span><span class="upperident">

Counter</span><span class="kw"> :=</span><span class="upperident"> I64</span><span class="lowerident">

init</span><span class="kw"> :</span><span class="upperident"> I64</span><span class="kw"> -&gt;</span><span class="upperident"> Counter</span><span class="lowerident">
init</span><span class="kw"> =</span><span class="upperident"> @</span><span class="upperident">Counter</span><span class="lowerident">

render</span><span class="kw"> :</span><span class="upperident"> Counter</span><span class="delimeter">,</span><span class="upperident"> Color</span><span class="kw"> -&gt;</span><span class="upperident"> Elem</span><span class="upperident"> Counter</span><span class="lowerident">
render</span><span class="kw"> =</span><span class="kw"> \</span><span class="upperident">@</span><span class="upperident">Counter</span><span class="lowerident"> state</span><span class="delimeter">,</span><span class="lowerident"> color</span><span class="kw"> -&gt;</span><span class="upperident">
    GUI</span><span class="delimeter">.</span><span class="lowerident">col</span><span class="delimeter"> [</span><span class="upperident">
        GUI</span><span class="delimeter">.</span><span class="lowerident">button</span><span class="delimeter"> {</span><span class="lowerident">
            text</span><span class="kw">:</span><span class="literal"> "+"</span><span class="delimeter">,</span><span class="lowerident">
            onPress</span><span class="kw">:</span><span class="kw"> \</span><span class="upperident">@</span><span class="upperident">Counter</span><span class="lowerident"> prev</span><span class="kw"> -&gt;</span><span class="upperident"> Action</span><span class="delimeter">.</span><span class="lowerident">update</span><span class="delimeter"> (</span><span class="upperident">@</span><span class="upperident">Counter</span><span class="delimeter"> (</span><span class="lowerident">prev</span><span class="op"> +</span><span class="literal"> 1</span><span class="delimeter">)</span><span class="delimeter">)</span><span class="delimeter">,</span><span class="delimeter">
        }</span><span class="delimeter">,</span><span class="upperident">
        GUI</span><span class="delimeter">.</span><span class="lowerident">text</span><span class="delimeter"> {</span><span class="lowerident">
            label</span><span class="kw">:</span><span class="literal"> "Clicked $(Num.toStr state) times"</span><span class="delimeter">,</span><span class="lowerident">
            color</span><span class="delimeter">,</span><span class="delimeter">
        }</span><span class="delimeter">,</span><span class="upperident">
        GUI</span><span class="delimeter">.</span><span class="lowerident">button</span><span class="delimeter"> {</span><span class="lowerident">
            text</span><span class="kw">:</span><span class="literal"> "-"</span><span class="delimeter">,</span><span class="lowerident">
            onPress</span><span class="kw">:</span><span class="kw"> \</span><span class="upperident">@</span><span class="upperident">Counter</span><span class="lowerident"> prev</span><span class="kw"> -&gt;</span><span class="upperident"> Action</span><span class="delimeter">.</span><span class="lowerident">update</span><span class="delimeter"> (</span><span class="upperident">@</span><span class="upperident">Counter</span><span class="delimeter"> (</span><span class="lowerident">prev</span><span class="op"> -</span><span class="literal"> 1</span><span class="delimeter">)</span><span class="delimeter">)</span><span class="delimeter">,</span><span class="delimeter">
        }</span><span class="delimeter">,</span><span class="delimeter">
    ]</span></samp></pre></main><footer></footer></body></html>